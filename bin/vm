#!/bin/bash

############## Set this to where you have installed vm ###############

#VM_LIB=/usr/local/vm/lib
VM_LIB=/home/daniel/Development/Projects/vm/lib

############## NO CONFIGURABLE PARTS BEYOND THIS POINT ###############

BASENAME=`which basename 2> /dev/null`

if [ -z $BASENAME ]; then
    echo "vm: your PATH seems to be set to something not entirely wholesome: '$PATH'" 1>&2
    exit 1
fi

. $VM_LIB/init.sh

if [ ! -f $VM_CONFIG ]; then vm_die configuration file \'$VM_CONFIG\' not present in current directory; fi

. $VM_CONFIG

CMD=$1
shift

KNOWN="start stop status cmd run init sh"

if [ -z $CMD ]; then
        for i in $KNOWN; do US="$US | $i"; done
        vm_die usage: vm \{${US## |} \}
fi


function export_vars()
{
    `grep ^VM_ $VM_LIB/../variables.txt | \
        while read line; do echo export $line; done`
}

case $CMD in
    start|stop|status|cmd|run|init)
                . $VM_LIB/vm-$CMD-options.sh
                . $VM_LIB/vm-$CMD.sh $*
        ;;
    sh)
        shift
        export_vars

        if [ "$SHELL" = "" ]; then export SHELL=bash; fi

        echo "Entering interactive mode; type 'exit' to quit."
        $SHELL $*
        ;;
    *)
        VM_HOME="$VM_HOME_ORIGIN"

        export_vars

        cd "$VM_CALLING_DIR"

        if [ -f "$CMD" ];
        then
            (echo "VM_PARAMS=\"$*\"; . $VM_LIB/functions.sh"; awk 'NR > 1 { print }' $CMD) | \
                (cd "$VM_HOME"; bash)
        else
                vm_die unknown command \'$CMD\', must be one of $KNOWN
        fi
    ;;
esac
